<!DOCTYPE html>
<html lang="en">

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
  <meta content="yes" name="apple-mobile-web-app-capable">
  <meta content="black-translucent" name="apple-mobile-web-app-status-bar-style">
  <meta content="telephone=no" name="format-detection">
  <meta name="description" content="Personal Blog">
  <title>深入理解Python并发 | linw1995</title>
  <link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0">
  <link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/6.0.0/normalize.min.css">
  <link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/pure-min.css">
  <link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/grids-responsive-min.css">
  <link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css">
  <script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
  <link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  <link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png">
  <link rel="alternate" type="application/atom+xml" href="/atom.xml">
  <script>
    (function(i, s, o, g, r, a, m) {
      i['GoogleAnalyticsObject'] = r;
      i[r] = i[r] || function() {
        (i[r].q = i[r].q || []).push(arguments)
      }, i[r].l = 1 * new Date();
      a = s.createElement(o),
        m = s.getElementsByTagName(o)[0];
      a.async = 1;
      a.src = g;
      m.parentNode.insertBefore(a, m)
    })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');
    ga('create', 'UA-86170223-1', 'auto');
    ga('send', 'pageview');
  </script>
</head>

<body>
  <div class="body_container">
    <div id="header">
      <div class="site-name">
        <h1 class="hidden">深入理解Python并发</h1><a id="logo" href="/.">linw1995</a>
        <p class="description"></p>
      </div>
      <div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> Home</i></a><a href="/archives/"><i class="fa fa-archive"> Archive</i></a><a href="/about/"><i class="fa fa-user"> About</i></a><a href="/atom.xml"><i class="fa fa-rss"> RSS</i></a></div>
    </div>
    <div id="layout" class="pure-g">
      <div class="pure-u-1 pure-u-md-4-4">
        <div class="content_container">
          <div class="post">
            <h1 class="post-title">深入理解Python并发</h1>
            <div class="post-meta">Jul 16, 2017<span> | </span><span class="category"><a href="/categories/Python/">Python</a></span>
              <script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span>
            </div>
            <a data-disqus-identifier="2017/07/16/深入理解Python并发/" href="/2017/07/16/深入理解Python并发/#disqus_thread" class="disqus-comment-count"></a>
            <div class="clear">
              <div id="toc" class="toc-article">
                <div class="toc-title">Contents</div>
                <ol class="toc">
                  <li class="toc-item toc-level-2"><a class="toc-link" href="#前言"><span class="toc-number">1.</span> <span class="toc-text">
  前言</span></a></li>
                  <li class="toc-item toc-level-2"><a class="toc-link" href="#并发Demo"><span class="toc-number">2.</span> <span class="toc-text">
  并发Demo</span></a></li>
                  <li class="toc-item toc-level-2"><a class="toc-link" href="#深入了解"><span class="toc-number">3.</span> <span class="toc-text">
  深入了解</span></a></li>
                  <li class="toc-item toc-level-2"><a class="toc-link" href="#async-await"><span class="toc-number">4.</span> <span class="toc-text">
    async/await</span></a></li>
                  <li class="toc-item toc-level-2"><a class="toc-link" href="#小结"><span class="toc-number">5.</span> <span class="toc-text">
    小结</span></a></li>
                  <li class="toc-item toc-level-2"><a class="toc-link" href="#参考链接"><span class="toc-number">6.</span> <span class="toc-text">
    参考链接</span></a></li>
                  <li class="toc-item toc-level-2"><a class="toc-link" href="#扩展阅读"><span class="toc-number">7.</span> <span class="toc-text">
    扩展阅读</span></a></li>
                </ol>
              </div>
            </div>
            <div class="post-content">
              <h2 id="前言">
                <a href="#前言" class="headerlink" title="前言"></a>前言</h2>
              <p>昨天（2017年7月15日）偶然看到这个视频，看完之后豁然开朗，忍不住要分享给大家。</p>
              <p><iframe width="560" height="315" src="https://www.youtube.com/embed/MCs5OvhV9S4" frameborder="0" allowfullscreen></iframe></p>
              <h2 id="并发Demo">
                <a href="#并发Demo" class="headerlink" title="并发Demo"></a>并发Demo</h2>
              <p>视频中举了个例子，用socket写了个迷你服务，只有一个作用，计算Fibonacci……</p>
              <figure class="highlight python">
                <table>
                  <tr>
                    <td class="gutter">
                      <pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre> </td>
                    <td class="code">
                      <pre><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"><span class="comment"># server.py</span></div><div class="line"><span class="keyword">import</span> socket</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">fib</span><span class="params">(n)</span>:</span></div><div class="line">    <span class="keyword">if</span> n &lt;= <span class="number">2</span>:</div><div class="line">        <span class="keyword">return</span> <span class="number">1</span></div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        <span class="keyword">return</span> fib(n - <span class="number">1</span>) + fib(n - <span class="number">2</span>)</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">server</span><span class="params">(addr, port)</span>:</span></div><div class="line">    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</div><div class="line">    sock.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class="number">1</span>)</div><div class="line">    sock.bind((addr, port))</div><div class="line">    sock.listen(<span class="number">5</span>)</div><div class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">        client, addr = sock.accept()</div><div class="line">        print(<span class="string">'Connection'</span>, addr)</div><div class="line">        handler(client)</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">handler</span><span class="params">(client)</span>:</span></div><div class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">        req = client.recv(<span class="number">100</span>)</div><div class="line">        <span class="keyword">if</span> <span class="keyword">not</span> req:</div><div class="line">            <span class="keyword">break</span></div><div class="line">        n = int(req)</div><div class="line">        result = fib(n)</div><div class="line">        resp = str(result).encode(<span class="string">'ascii'</span>) + <span class="string">b'\n'</span></div><div class="line">        client.send(resp)</div><div class="line">    print(<span class="string">"Connection Closed"</span>)</div><div class="line"></div><div class="line"></div><div class="line">server(<span class="string">""</span>, <span class="number">25000</span>)</div></pre> </td>
                  </tr>
                </table>
              </figure>
              <p>当然目前这个只是一个堵塞版本，可以用以下代码测试一下</p>
              <figure class="highlight python">
                <table>
                  <tr>
                    <td class="gutter">
                      <pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre> </td>
                    <td class="code">
                      <pre><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"><span class="comment"># nc.py</span></div><div class="line"><span class="keyword">import</span> socket</div><div class="line"></div><div class="line">sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</div><div class="line">sock.connect((<span class="string">'localhost'</span>, <span class="number">25000</span>))</div><div class="line"></div><div class="line"><span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">    n = input()</div><div class="line">    sock.send(n.encode(<span class="string">'ascii'</span>))</div><div class="line">    resp = sock.recv(<span class="number">100</span>)</div><div class="line">    print(resp.decode(<span class="string">'ascii'</span>), end=<span class="string">''</span>)</div></pre> </td>
                  </tr>
                </table>
              </figure>
              <p>该迷你服务一次只能处理一个请求，我们只需要稍微修改一下代码即可以改变现状</p>
              <figure class="highlight python">
                <table>
                  <tr>
                    <td class="gutter">
                      <pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre> </td>
                    <td class="code">
                      <pre><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"><span class="comment"># server.py</span></div><div class="line"><span class="keyword">import</span> socket</div><div class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">fib</span><span class="params">(n)</span>:</span></div><div class="line">    <span class="keyword">if</span> n &lt;= <span class="number">2</span>:</div><div class="line">        <span class="keyword">return</span> <span class="number">1</span></div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        <span class="keyword">return</span> fib(n - <span class="number">1</span>) + fib(n - <span class="number">2</span>)</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">server</span><span class="params">(addr, port)</span>:</span></div><div class="line">    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</div><div class="line">    sock.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class="number">1</span>)</div><div class="line">    sock.bind((addr, port))</div><div class="line">    sock.listen(<span class="number">5</span>)</div><div class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">        client, addr = sock.accept()</div><div class="line">        print(<span class="string">'Connection'</span>, addr)</div><div class="line">        Thread(target=handler, args=(client,), daemon=<span class="keyword">True</span>).start()</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">handler</span><span class="params">(client)</span>:</span></div><div class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">        req = client.recv(<span class="number">100</span>)</div><div class="line">        <span class="keyword">if</span> <span class="keyword">not</span> req:</div><div class="line">            <span class="keyword">break</span></div><div class="line">        n = int(req)</div><div class="line">        result = fib(n)</div><div class="line">        resp = str(result).encode(<span class="string">'ascii'</span>) + <span class="string">b'\n'</span></div><div class="line">        client.send(resp)</div><div class="line">    print(<span class="string">"Connection Closed"</span>)</div><div class="line"></div><div class="line"></div><div class="line">server(<span class="string">""</span>, <span class="number">25000</span>)</div></pre> </td>
                  </tr>
                </table>
              </figure>
              <p>每次收到请求，就会开启一个新的线程来处理。用以下代码来测试其性能。</p>
              <figure class="highlight python">
                <table>
                  <tr>
                    <td class="gutter">
                      <pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre> </td>
                    <td class="code">
                      <pre><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"><span class="comment"># perf.py</span></div><div class="line"><span class="keyword">import</span> socket</div><div class="line"><span class="keyword">import</span> time</div><div class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread</div><div class="line"></div><div class="line">sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</div><div class="line">sock.connect((<span class="string">'localhost'</span>, <span class="number">25000</span>))</div><div class="line"></div><div class="line">counter = <span class="number">0</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">monitor</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">global</span> counter</div><div class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">        time.sleep(<span class="number">1</span>)</div><div class="line">        print(counter, <span class="string">'reqs/sec'</span>)</div><div class="line">        counter = <span class="number">0</span></div><div class="line"></div><div class="line"></div><div class="line">Thread(target=monitor, daemon=<span class="keyword">True</span>).start()</div><div class="line"></div><div class="line"><span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">    sock.send(<span class="string">b'1'</span>)</div><div class="line">    resp = sock.recv(<span class="number">100</span>)</div><div class="line">    counter += <span class="number">1</span></div></pre> </td>
                  </tr>
                </table>
              </figure>
              <p>每当多开启一个测试端，各个测试端每秒请求数量或多或少都会受到影响。而且当我们用nc.py作一个需要大量计算资源请求，比如 <code>fib(40)</code> ,结果更是惨不忍睹。若是我们把线程换成进程。</p>
              <figure class="highlight python">
                <table>
                  <tr>
                    <td class="gutter">
                      <pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre> </td>
                    <td class="code">
                      <pre><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"><span class="comment"># server.py</span></div><div class="line"><span class="keyword">import</span> socket</div><div class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread</div><div class="line"><span class="keyword">from</span> concurrent.futures <span class="keyword">import</span> ProcessPoolExecutor <span class="keyword">as</span> Pool</div><div class="line"></div><div class="line">pool = Pool(<span class="number">10</span>)</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">fib</span><span class="params">(n)</span>:</span></div><div class="line">    <span class="keyword">if</span> n &lt;= <span class="number">2</span>:</div><div class="line">        <span class="keyword">return</span> <span class="number">1</span></div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        <span class="keyword">return</span> fib(n - <span class="number">1</span>) + fib(n - <span class="number">2</span>)</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">server</span><span class="params">(addr, port)</span>:</span></div><div class="line">    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</div><div class="line">    sock.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class="number">1</span>)</div><div class="line">    sock.bind((addr, port))</div><div class="line">    sock.listen(<span class="number">5</span>)</div><div class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">        client, addr = sock.accept()</div><div class="line">        print(<span class="string">'Connection'</span>, addr)</div><div class="line">        Thread(target=handler, args=(client, ), daemon=<span class="keyword">True</span>).start()</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">handler</span><span class="params">(client)</span>:</span></div><div class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">        req = client.recv(<span class="number">100</span>)</div><div class="line">        <span class="keyword">if</span> <span class="keyword">not</span> req:</div><div class="line">            <span class="keyword">break</span></div><div class="line">        n = int(req)</div><div class="line">        future = pool.submit(fib, n)</div><div class="line">        result = future.result()</div><div class="line">        resp = str(result).encode(<span class="string">'ascii'</span>) + <span class="string">b'\n'</span></div><div class="line">        client.send(resp)</div><div class="line">    print(<span class="string">"Connection Closed"</span>)</div><div class="line"></div><div class="line"><span class="comment"># 使用ProcessPoolExecutor必须用</span></div><div class="line"><span class="comment"># if __name__ == '__main__':</span></div><div class="line"><span class="comment">#     main()</span></div><div class="line"><span class="comment"># 因为子进程会导入__main__模块，若不用此方法避免子进程重复执行主进程的代码，</span></div><div class="line"><span class="comment"># 可能会导致一些奇怪的结果</span></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    server(<span class="string">""</span>, <span class="number">25000</span>)</div></pre> </td>
                  </tr>
                </table>
              </figure>
              <p>当然，我们要使用 <strong>ProcessPoolExecutor</strong> 来执行 <strong>CPU密集型任务</strong> ；用 <strong>ThreadPoolExecutor</strong> 更适合 <strong>I/O密集型任务</strong> 。这样突然来了一个需要 <code>fib(40)</code> 的请求，也不会造成很大的影响。不过各个测试端的每秒请求数量，会比之前降了一个数量级，这是因为解释器与子进程沟通的消耗导致的。</p>
              <h2 id="深入了解">
                <a href="#深入了解" class="headerlink" title="深入了解"></a>深入了解</h2>
              <p>视频来到高潮部分，David Beazley讲Python圈子里有个特别火的观点，就是用 <code>threading</code> 非常糟糕，不要用！所以他把代码恢复到原来的版本。</p>
              <figure class="highlight python">
                <table>
                  <tr>
                    <td class="gutter">
                      <pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre> </td>
                    <td class="code">
                      <pre><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"><span class="comment"># server.py</span></div><div class="line"><span class="keyword">import</span> socket</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">fib</span><span class="params">(n)</span>:</span></div><div class="line">    <span class="keyword">if</span> n &lt;= <span class="number">2</span>:</div><div class="line">        <span class="keyword">return</span> <span class="number">1</span></div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        <span class="keyword">return</span> fib(n - <span class="number">1</span>) + fib(n - <span class="number">2</span>)</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">server</span><span class="params">(addr, port)</span>:</span></div><div class="line">    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</div><div class="line">    sock.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class="number">1</span>)</div><div class="line">    sock.bind((addr, port))</div><div class="line">    sock.listen(<span class="number">5</span>)</div><div class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">        client, addr = sock.accept()</div><div class="line">        print(<span class="string">'Connection'</span>, addr)</div><div class="line">        handler(client)</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">handler</span><span class="params">(client)</span>:</span></div><div class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">        req = client.recv(<span class="number">100</span>)</div><div class="line">        <span class="keyword">if</span> <span class="keyword">not</span> req:</div><div class="line">        <span class="keyword">break</span></div><div class="line">        n = int(req)</div><div class="line">        result = fib(n)</div><div class="line">        resp = str(result).encode(<span class="string">'ascii'</span>) + <span class="string">b'\n'</span></div><div class="line">        client.send(resp)</div><div class="line">    print(<span class="string">"Connection Closed"</span>)</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    server(<span class="string">""</span>, <span class="number">25000</span>)</div></pre> </td>
                  </tr>
                </table>
              </figure>
              <p>如果不用 <code>threading</code> 模块，如何做到并发呢？用Python中的生成器特性，使用yield关键字。</p>
              <figure class="highlight python">
                <table>
                  <tr>
                    <td class="gutter">
                      <pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre> </td>
                    <td class="code">
                      <pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="function"><span class="keyword">def</span> <span class="title">countdown</span><span class="params">(n)</span>:</span></div><div class="line"><span class="meta">... </span>    <span class="keyword">while</span> n &gt; <span class="number">0</span>:</div><div class="line"><span class="meta">... </span>        <span class="keyword">yield</span> n</div><div class="line"><span class="meta">... </span>n -= <span class="number">1</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>cd = countdown(<span class="number">3</span>)</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>next(cd)</div><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="number">3</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">for</span> i <span class="keyword">in</span> cd:</div><div class="line"><span class="meta">... </span>    print(i)</div><div class="line"><span class="number">2</span></div><div class="line"><span class="number">1</span></div><div class="line"></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>next(cd)</div><div class="line">Traceback (most recent call last):</div><div class="line">    File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</div><div class="line">StopIteration</div></pre> </td>
                  </tr>
                </table>
              </figure>
              <p>当解释器运行到yield会返回结果，并挂起该函数，等待下次激活。利用这个特性，稍微修改一下代码</p>
              <figure class="highlight python">
                <table>
                  <tr>
                    <td class="gutter">
                      <pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div></pre> </td>
                    <td class="code">
                      <pre><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"><span class="comment"># server.py</span></div><div class="line"><span class="keyword">import</span> socket</div><div class="line"><span class="keyword">import</span> select</div><div class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> deque</div><div class="line"></div><div class="line">tasks = deque()</div><div class="line">recv_wait = dict() <span class="comment"># Mapping sockets -&gt; tasks (generators)</span></div><div class="line">send_wait = dict()</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">while</span> any([tasks, recv_wait, send_wait]):</div><div class="line">        <span class="keyword">while</span> <span class="keyword">not</span> tasks:</div><div class="line">            <span class="comment"># 没有正在运行的task</span></div><div class="line">            <span class="comment"># 等待I/O操作</span></div><div class="line">            can_recv, can_send, _ = select.select(recv_wait, send_wait, [])</div><div class="line">            <span class="keyword">for</span> sock <span class="keyword">in</span> can_recv:</div><div class="line">                tasks.append(recv_wait.pop(sock))</div><div class="line">            <span class="keyword">for</span> sock <span class="keyword">in</span> can_send:</div><div class="line">                tasks.append(send_wait.pop(sock))</div><div class="line"></div><div class="line">        task = tasks.popleft()</div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            why, what = next(task)</div><div class="line">            <span class="keyword">if</span> why == <span class="string">'recv'</span>:</div><div class="line">                recv_wait[what] = task</div><div class="line">            <span class="keyword">elif</span> why == <span class="string">'send'</span>:</div><div class="line">                send_wait[what] = task</div><div class="line">            <span class="keyword">else</span>:</div><div class="line">                <span class="keyword">raise</span> RuntimeError(<span class="string">'需要参数!'</span>)</div><div class="line">        <span class="keyword">except</span> StopIteration:</div><div class="line">            print(<span class="string">'Task Done!'</span>)</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">fib</span><span class="params">(n)</span>:</span></div><div class="line">    <span class="keyword">if</span> n &lt;= <span class="number">2</span>:</div><div class="line">        <span class="keyword">return</span> <span class="number">1</span></div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        <span class="keyword">return</span> fib(n - <span class="number">1</span>) + fib(n - <span class="number">2</span>)</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">server</span><span class="params">(addr, port)</span>:</span></div><div class="line">    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</div><div class="line">    sock.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class="number">1</span>)</div><div class="line">    sock.bind((addr, port))</div><div class="line">    sock.listen(<span class="number">5</span>)</div><div class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">        <span class="keyword">yield</span> <span class="string">'recv'</span>, sock</div><div class="line">        client, addr = sock.accept()</div><div class="line">        print(<span class="string">'Connection'</span>, addr)</div><div class="line">        tasks.append(handler(client)) <span class="comment"># 添加新任务</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">handler</span><span class="params">(client)</span>:</span></div><div class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">        <span class="keyword">yield</span> <span class="string">'recv'</span>, client</div><div class="line">        req = client.recv(<span class="number">100</span>)</div><div class="line">        <span class="keyword">if</span> <span class="keyword">not</span> req:</div><div class="line">            <span class="keyword">break</span></div><div class="line">        n = int(req)</div><div class="line">        result = fib(n)</div><div class="line">        resp = str(result).encode(<span class="string">'ascii'</span>) + <span class="string">b'\n'</span></div><div class="line">        <span class="keyword">yield</span> <span class="string">'send'</span>, client</div><div class="line">        client.send(resp)</div><div class="line">    print(<span class="string">"Connection Closed"</span>)</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    tasks.append(server(<span class="string">""</span>, <span class="number">25000</span>)) <span class="comment"># 添加初始任务</span></div><div class="line">    run()</div></pre> </td>
                  </tr>
                </table>
              </figure>
              <p>在需要进行I/O操作的地方使用 <code>yield</code> ，挂起该函数，用 <code>select</code> 查看socket的I/O操作是否准备好。准备好就唤醒该函数，执行I/O操作。使用perf.py或者nc.py测试一下，发现我们成功地实现了并发，没用借助 <code>threading</code> 模块。但我们遇到CPU密集型任务，该代码的表现就乏善可陈。我们尝试用 <code>ProcessPoolExecutor</code> 来解决这个问题</p>
              <figure class="highlight python">
                <table>
                  <tr>
                    <td class="gutter">
                      <pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div></pre> </td>
                    <td class="code">
                      <pre><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"><span class="comment"># server.py</span></div><div class="line"><span class="keyword">import</span> socket</div><div class="line"><span class="keyword">import</span> select</div><div class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> deque</div><div class="line"><span class="keyword">from</span> concurrent.futures <span class="keyword">import</span> ProcessPoolExecutor <span class="keyword">as</span> Pool</div><div class="line"></div><div class="line">pool = Pool(<span class="number">10</span>)</div><div class="line">tasks = deque()</div><div class="line">recv_wait = dict() <span class="comment"># Mapping sockets -&gt; tasks (generators)</span></div><div class="line">send_wait = dict()</div><div class="line">future_wait = dict()</div><div class="line"></div><div class="line">future_notify, future_event = socket.socketpair()</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">future_done</span><span class="params">(future)</span>:</span></div><div class="line">    tasks.append(future_wait.pop(future))</div><div class="line">    future_notify.send(<span class="string">b'x'</span>)</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">future_monitor</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">        <span class="keyword">yield</span> <span class="string">'recv'</span>, future_event</div><div class="line">        future_event.recv(<span class="number">100</span>)</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">while</span> any([tasks, recv_wait, send_wait]):</div><div class="line">        <span class="keyword">while</span> <span class="keyword">not</span> tasks:</div><div class="line">            <span class="comment"># 没有正在运行的task</span></div><div class="line">            <span class="comment"># 等待I/O操作</span></div><div class="line">            can_recv, can_send, _ = select.select(recv_wait, send_wait, [])</div><div class="line">            <span class="keyword">for</span> sock <span class="keyword">in</span> can_recv:</div><div class="line">                tasks.append(recv_wait.pop(sock))</div><div class="line">            <span class="keyword">for</span> sock <span class="keyword">in</span> can_send:</div><div class="line">                tasks.append(send_wait.pop(sock))</div><div class="line"></div><div class="line">        task = tasks.popleft()</div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            why, what = next(task)</div><div class="line">            <span class="keyword">if</span> why == <span class="string">'recv'</span>:</div><div class="line">                recv_wait[what] = task</div><div class="line">            <span class="keyword">elif</span> why == <span class="string">'send'</span>:</div><div class="line">                send_wait[what] = task</div><div class="line">            <span class="keyword">elif</span> why == <span class="string">'future'</span>:</div><div class="line">                future_wait[what] = task</div><div class="line">                what.add_done_callback(future_done)</div><div class="line">            <span class="keyword">else</span>:</div><div class="line">                <span class="keyword">raise</span> RuntimeError(<span class="string">'需要参数!'</span>)</div><div class="line">        <span class="keyword">except</span> (StopIteration, ConnectionResetError):</div><div class="line">            print(<span class="string">'Task Done!'</span>)</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">fib</span><span class="params">(n)</span>:</span></div><div class="line">    <span class="keyword">if</span> n &lt;= <span class="number">2</span>:</div><div class="line">        <span class="keyword">return</span> <span class="number">1</span></div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        <span class="keyword">return</span> fib(n - <span class="number">1</span>) + fib(n - <span class="number">2</span>)</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">server</span><span class="params">(addr, port)</span>:</span></div><div class="line">    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</div><div class="line">    sock.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class="number">1</span>)</div><div class="line">    sock.bind((addr, port))</div><div class="line">    sock.listen(<span class="number">5</span>)</div><div class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">        <span class="keyword">yield</span> <span class="string">'recv'</span>, sock</div><div class="line">        client, addr = sock.accept()</div><div class="line">        print(<span class="string">'Connection'</span>, addr)</div><div class="line">        tasks.append(handler(client))</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">handler</span><span class="params">(client)</span>:</span></div><div class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">        <span class="keyword">yield</span> <span class="string">'recv'</span>, client</div><div class="line">        req = client.recv(<span class="number">100</span>)</div><div class="line">        <span class="keyword">if</span> <span class="keyword">not</span> req:</div><div class="line">            <span class="keyword">break</span></div><div class="line">        n = int(req)</div><div class="line">        future = pool.submit(fib, n)</div><div class="line">        <span class="keyword">yield</span> <span class="string">'future'</span>, future</div><div class="line">        result = future.result()</div><div class="line">        resp = str(result).encode(<span class="string">'ascii'</span>) + <span class="string">b'\n'</span></div><div class="line">        <span class="keyword">yield</span> <span class="string">'send'</span>, client</div><div class="line">        client.send(resp)</div><div class="line">        print(<span class="string">"Closed"</span>)</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    tasks.append(server(<span class="string">""</span>, <span class="number">25000</span>))</div><div class="line">    tasks.append(future_monitor())</div><div class="line">    run()</div></pre> </td>
                  </tr>
                </table>
              </figure>
              <p>因为future对象不是文件描述符，无法用 <code>select</code> 来查看任务是否完成。但有更好的方法，future对象支持添加callback函数。用 <code>socket.socketpair</code> 配合 <code>future.add_done_callback</code> 函数来解决这个问题。接下来有个小问题， <code>yield</code> 在代码中很突兀，有什么办法把它包装起来？！？</p>
              <figure class="highlight python">
                <table>
                  <tr>
                    <td class="gutter">
                      <pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div></pre> </td>
                    <td class="code">
                      <pre><div class="line"><span class="comment"># -*- co```ding: utf-8 -*-</span></div><div class="line"><span class="comment"># server.py</span></div><div class="line"><span class="keyword">import</span> socket</div><div class="line"><span class="keyword">import</span> select</div><div class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> deque</div><div class="line"><span class="keyword">from</span> concurrent.futures <span class="keyword">import</span> ProcessPoolExecutor <span class="keyword">as</span> Pool</div><div class="line"></div><div class="line">pool = Pool(<span class="number">10</span>)</div><div class="line">tasks = deque()</div><div class="line">recv_wait = dict() <span class="comment"># Mapping sockets -&gt; tasks (generators)</span></div><div class="line">send_wait = dict()</div><div class="line">future_wait = dict()</div><div class="line"></div><div class="line">future_notify, future_event = socket.socketpair()</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">future_done</span><span class="params">(future)</span>:</span></div><div class="line">    tasks.append(future_wait.pop(future))</div><div class="line">    future_notify.send(<span class="string">b'x'</span>)</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">future_monitor</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">        <span class="keyword">yield</span> <span class="string">'recv'</span>, future_event</div><div class="line">        future_event.recv(<span class="number">100</span>)</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">while</span> any([tasks, recv_wait, send_wait]):</div><div class="line">        <span class="keyword">while</span> <span class="keyword">not</span> tasks:</div><div class="line">            <span class="comment"># 没有正在运行的task</span></div><div class="line">            <span class="comment"># 等待I/O操作</span></div><div class="line">            can_recv, can_send, _ = select.select(recv_wait, send_wait, [])</div><div class="line">            <span class="keyword">for</span> sock <span class="keyword">in</span> can_recv:</div><div class="line">                tasks.append(recv_wait.pop(sock))</div><div class="line">            <span class="keyword">for</span> sock <span class="keyword">in</span> can_send:</div><div class="line">                tasks.append(send_wait.pop(sock))</div><div class="line"></div><div class="line">        task = tasks.popleft()</div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            why, what = next(task)</div><div class="line">            <span class="keyword">if</span> why == <span class="string">'recv'</span>:</div><div class="line">                recv_wait[what] = task</div><div class="line">            <span class="keyword">elif</span> why == <span class="string">'send'</span>:</div><div class="line">                send_wait[what] = task</div><div class="line">            <span class="keyword">elif</span> why == <span class="string">'future'</span>:</div><div class="line">                future_wait[what] = task</div><div class="line">                what.add_done_callback(future_done)</div><div class="line">            <span class="keyword">else</span>:</div><div class="line">                <span class="keyword">raise</span> RuntimeError(<span class="string">'需要参数!'</span>)</div><div class="line">        <span class="keyword">except</span> (StopIteration, ConnectionResetError):</div><div class="line">            print(<span class="string">'Task Done!'</span>)</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">fib</span><span class="params">(n)</span>:</span></div><div class="line">    <span class="keyword">if</span> n &lt;= <span class="number">2</span>:</div><div class="line">        <span class="keyword">return</span> <span class="number">1</span></div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        <span class="keyword">return</span> fib(n - <span class="number">1</span>) + fib(n - <span class="number">2</span>)</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">AsyncSocket</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, sock)</span>:</span></div><div class="line">        self.sock = sock</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">recv</span><span class="params">(self, maxsize)</span>:</span></div><div class="line">        <span class="keyword">yield</span> <span class="string">'recv'</span>, self.sock</div><div class="line">        <span class="keyword">return</span> self.sock.recv(maxsize)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">send</span><span class="params">(self, data)</span>:</span></div><div class="line">        <span class="keyword">yield</span> <span class="string">'send'</span>, self.sock</div><div class="line">        <span class="keyword">return</span> self.sock.send(data)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">accept</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">yield</span> <span class="string">'recv'</span>, self.sock</div><div class="line">        client, addr = self.sock.accept()</div><div class="line">        <span class="keyword">return</span> AsyncSocket(client), addr</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getattr__</span><span class="params">(self, name)</span>:</span></div><div class="line">        <span class="keyword">return</span> getattr(self.sock, name)</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">server</span><span class="params">(addr, port)</span>:</span></div><div class="line">    sock = AsyncSocket(socket.socket(socket.AF_INET, socket.SOCK_STREAM))</div><div class="line">    sock.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class="number">1</span>)</div><div class="line">    sock.bind((addr, port))</div><div class="line">    sock.listen(<span class="number">5</span>)</div><div class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">        client, addr = <span class="keyword">yield</span> <span class="keyword">from</span> sock.accept()</div><div class="line">        print(<span class="string">'Connection'</span>, addr)</div><div class="line">        tasks.append(handler(client))</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">handler</span><span class="params">(client)</span>:</span></div><div class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">        req = <span class="keyword">yield</span> <span class="keyword">from</span> client.recv(<span class="number">100</span>)</div><div class="line">        <span class="keyword">if</span> <span class="keyword">not</span> req:</div><div class="line">            <span class="keyword">break</span></div><div class="line">        n = int(req)</div><div class="line">        future = pool.submit(fib, n)</div><div class="line">        <span class="keyword">yield</span> <span class="string">'future'</span>, future</div><div class="line">        result = future.result()</div><div class="line">        resp = str(result).encode(<span class="string">'ascii'</span>) + <span class="string">b'\n'</span></div><div class="line">        <span class="keyword">yield</span> <span class="keyword">from</span> client.send(resp)</div><div class="line">    print(<span class="string">"Connection Closed"</span>)</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    tasks.append(server(<span class="string">""</span>, <span class="number">25000</span>))</div><div class="line">    tasks.append(future_monitor())</div><div class="line">    run()</div></pre> </td>
                  </tr>
                </table>
              </figure>
              <p><code>yield from</code> 是用来代理子生成器的，一种简单方式来控制子生成器的行为。在Python3.5之后，这种写法就可以用更简单的 <code>async/await</code> 来代替。</p>
              <h2 id="async-await">
                <a href="#async-await" class="headerlink" title="async/await"></a>async/await</h2>
              <p>看了这个视频后，就看了pycon上关于Asynchronous的视频。研究了一下3.5后的协程语法，把代码修改成以下的样子。</p>
              <figure class="highlight python">
                <table>
                  <tr>
                    <td class="gutter">
                      <pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div></pre> </td>
                    <td class="code">
                      <pre><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"><span class="comment"># server.py</span></div><div class="line"><span class="keyword">import</span> asyncio</div><div class="line"><span class="keyword">import</span> logging</div><div class="line"><span class="keyword">import</span> sys</div><div class="line"><span class="keyword">from</span> concurrent.futures <span class="keyword">import</span> ProcessPoolExecutor <span class="keyword">as</span> Executor</div><div class="line"></div><div class="line">logger = logging.getLogger(<span class="string">'SERVER'</span>)</div><div class="line">logging.basicConfig(stream=sys.stdout, level=logging.INFO)</div><div class="line">executor = Executor(<span class="number">4</span>)</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">fib</span><span class="params">(n: int)</span> -&gt; int:</span></div><div class="line">    <span class="keyword">if</span> n &lt;= <span class="number">2</span>:</div><div class="line">        <span class="keyword">return</span> <span class="number">1</span></div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        <span class="keyword">return</span> fib(n - <span class="number">1</span>) + fib(n - <span class="number">2</span>)</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">handler</span><span class="params">(reader: asyncio.StreamReader, writer: asyncio.StreamWriter)</span>:</span></div><div class="line">    addr = writer.get_extra_info(<span class="string">'peername'</span>)</div><div class="line">    logger.info(<span class="string">'Connection&lt;%s:%d&gt; Created'</span>, *addr)</div><div class="line">    loop = asyncio.get_event_loop()</div><div class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">        req = <span class="keyword">await</span> reader.readline()</div><div class="line">        <span class="keyword">if</span> <span class="keyword">not</span> req.strip():</div><div class="line">            <span class="keyword">break</span></div><div class="line">        logger.debug(<span class="string">'Connection&lt;%s:%d&gt; Recv %r'</span>, *addr, req)</div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            n = int(req)</div><div class="line">            future = loop.run_in_executor(executor, fib, n)</div><div class="line">            result = <span class="keyword">await</span> asyncio.gather(future, return_exceptions=<span class="keyword">True</span>)</div><div class="line">            <span class="keyword">if</span> isinstance(result, Exception):</div><div class="line">                <span class="keyword">break</span></div><div class="line">            resp = str(result[<span class="number">0</span>]).encode(<span class="string">'ascii'</span>) + <span class="string">b'\n'</span></div><div class="line">            logger.debug(<span class="string">'Connection&lt;%s:%d&gt; Send %r'</span>, *addr, resp)</div><div class="line">            writer.write(resp)</div><div class="line">            <span class="keyword">await</span> writer.drain()</div><div class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</div><div class="line">            writer.write(<span class="string">b'[Error]\n'</span>)</div><div class="line">            <span class="keyword">await</span> writer.drain()</div><div class="line">            logger.exception(e)</div><div class="line">            <span class="keyword">continue</span></div><div class="line">    writer.close()</div><div class="line">    logger.info(<span class="string">'Connection&lt;%s:%d&gt; Done'</span>, *addr)</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">Server</span><span class="params">(host: str, port: int)</span>:</span></div><div class="line">    loop = asyncio.get_event_loop()</div><div class="line">    coro = asyncio.start_server(handler, host, port, loop=loop)</div><div class="line">    server = loop.run_until_complete(coro)</div><div class="line"></div><div class="line">    print(<span class="string">'Serving on http://%s:%d'</span> % (host, port))</div><div class="line">    <span class="keyword">try</span>:</div><div class="line">        loop.run_forever()</div><div class="line">    <span class="keyword">finally</span>:</div><div class="line">        executor.shutdown()</div><div class="line">        server.close()</div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            loop.run_until_complete(server.wait_closed())</div><div class="line">        <span class="keyword">finally</span>:</div><div class="line">            <span class="keyword">pass</span></div><div class="line">        loop.close()</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></div><div class="line">    Server(<span class="string">'localhost'</span>, <span class="number">12345</span>)</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    main()</div></pre> </td>
                  </tr>
                </table>
              </figure>
              <p>是不是看起简洁了许多？刚学体会也不是很深，不是很了解。但觉得代码可读性变好了。</p>
              <h2 id="小结">
                <a href="#小结" class="headerlink" title="小结"></a>小结</h2>
              <table>
                <thead>
                  <tr>
                    <th>CPU密集型任务</th>
                    <th>IO密集型任务</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td><code>multiprocessing</code></td>
                    <td><code>threading</code></td>
                  </tr>
                  <tr>
                    <td><code>concurrent.futures.ProcessPoolExecutor</code></td>
                    <td><code>concurrent.futures.ThreadPoolExecutor</code></td>
                  </tr>
                  <tr>
                    <td></td>
                    <td><code>async / await</code></td>
                  </tr>
                </tbody>
              </table>
              <p>以上关于<strong>Fibonacci</strong>的例子是为了更好地理解并发，不是一个很好的算法。</p>
              <figure class="highlight python">
                <table>
                  <tr>
                    <td class="gutter">
                      <pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre> </td>
                    <td class="code">
                      <pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">fib</span><span class="params">(n)</span>:</span></div><div class="line">    a , b = <span class="number">1</span>, <span class="number">1</span></div><div class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> range(n):</div><div class="line">        a, b = b, a + b</div><div class="line">    <span class="keyword">return</span> a</div></pre> </td>
                  </tr>
                </table>
              </figure>
              <p>使用以上版本大大加快了<code>fib</code>的计算速度，就没必要用多进程了。<br>其实在多线程中最好不要开多进程，因为可能会出现死锁，导致程序出现不可预知的错误。因此，必须慎重对待多进程和多线程混搭使用。</p>
              <h2 id="参考链接">
                <a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2>
              <ul>
                <li><a href="https://docs.python.org/dev/library/concurrent.futures.html#processpoolexecutor-example" target="_blank" rel="external">17.4.3. ProcessPoolExecutor | Python Docs</a></li>
                <li><a href="http://masnun.com/2016/03/29/python-a-quick-introduction-to-the-concurrent-futures-module.html" target="_blank" rel="external">PYTHON: A QUICK INTRODUCTION TO THE CONCURRENT.FUTURES MODULE</a></li>
                <li><a href="https://docs.python.org/3/reference/expressions.html?highlight=yield#yield-expressions" target="_blank" rel="external">6.2.9. Yield expressions | Python Docs</a></li>
                <li><a href="http://blog.theerrorlog.com/yield-from-in-python-3.html" target="_blank" rel="external">Python3中的yield from语法</a></li>
                <li><a href="https://www.python.org/dev/peps/pep-0380/" target="_blank" rel="external">PEP 380 — Syntax for Delegating to a Subgenerator</a></li>
              </ul>
              <h2 id="扩展阅读">
                <a href="#扩展阅读" class="headerlink" title="扩展阅读"></a>扩展阅读</h2>
              <ul>
                <li>
                  <p>Pycon Montreal, David&#39;s talk所出现的所有代码<br> <a href="https://github.com/codeAshu/concurrency" target="_blank" rel="external">codeAshu/concurrency | GitHub</a></p>
                </li>
                <li>
                  <p>协程语法async与await<br> <a href="https://www.python.org/dev/peps/pep-0492/" target="_blank" rel="external">PEP 492 — Coroutines with async and await syntax</a></p>
                </li>
                <li>
                  <p>Python异步入门指南<br> <a href="https://www.youtube.com/watch?v=Bv25Dwe84g0" target="_blank" rel="external">Thinking about Concurrency, Raymond Hettinger, Python core developer | PyCon Russia 2016</a><br> <a href="https://youtu.be/iG6fr81xHKA"
                      target="_blank" rel="external">Miguel Grinberg Asynchronous Python for the Complete Beginner PyCon 2017</a></p>
                </li>
              </ul>
            </div>
            <script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://linw1995.com/2017/07/16/深入理解Python并发/" data-id="cj7yunbc2003rpcitjl04th2g" class="article-share-link">Share</a>
            <div class="tags"><a href="/tags/Python/">Python</a><a href="/tags/并发/">并发</a></div>
            <div class="post-nav"><a href="/2017/08/07/Windows上程序员神器——Cmder/" class="pre">Windows上程序员神器——Cmder</a><a href="/2017/06/25/用golang给图片打水印/" class="next">用golang给图片打水印</a></div>
            <div id="disqus_thread">
              <div class="btn_click_load"><button class="disqus_click_btn">阅读评论 「请确保 disqus.com 可以正常加载」</button></div>
              <script>
                var disqus_shortname = 'linw1995';
                var disqus_identifier = '2017/07/16/深入理解Python并发/';
                var disqus_title = '深入理解Python并发';
                var disqus_url = 'http://linw1995.com/2017/07/16/深入理解Python并发/';
                $('.btn_click_load').click(function() {
                  (function() {
                    var dsq = document.createElement('script');
                    dsq.type = 'text/javascript';
                    dsq.async = true;
                    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                  })();
                  $('.btn_click_load').css('display', 'none');
                });
                $.ajax({
                  url: 'https://disqus.com/favicon.ico',
                  timeout: 3000,
                  type: 'GET',
                  success: (function() {
                    var dsq = document.createElement('script');
                    dsq.type = 'text/javascript';
                    dsq.async = true;
                    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                    $('.btn_click_load').css('display', 'none');
                  })(),
                  error: function() {
                    $('.btn_click_load').css('display', 'block');
                  }
                });
              </script>
              <script id="dsq-count-scr" src="//linw1995.disqus.com/count.js" async></script>
            </div>
          </div>
        </div>
      </div>
      <div class="pure-u-1 pure-u-md-4-4">
        <div id="footer">Copyright © 2017 <a href="/." rel="nofollow">linw1995.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow"
            target="_blank" href="https://github.com/pagecho"> Cho.</a></div>
      </div>
    </div>
    <a id="rocket" href="#top" class="show"></a>
    <script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script>
    <script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.js" async></script>
    <script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script>
    <link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.css">
    <script type="text/javascript" src="/js/search.js?v=0.0.0"></script>
    <script>
      var search_path = 'search.xml';
      if (search_path.length == 0) {
        search_path = 'search.xml';
      }
      var path = '/' + search_path;
      searchFunc(path, 'local-search-input', 'local-search-result');
    </script>
    <script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script>
    <script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script>
  </div>
</body>

</html>