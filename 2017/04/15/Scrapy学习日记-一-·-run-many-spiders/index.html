<!DOCTYPE html>
<html lang="en">

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
  <meta content="yes" name="apple-mobile-web-app-capable">
  <meta content="black-translucent" name="apple-mobile-web-app-status-bar-style">
  <meta content="telephone=no" name="format-detection">
  <meta name="description" content="Personal Blog">
  <title>Scrapy学习日记 一 · run many spiders | linw1995</title>
  <link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.2">
  <link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/6.0.0/normalize.min.css">
  <link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/pure-min.css">
  <link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/grids-responsive-min.css">
  <link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css">
  <script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
  <link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  <link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png">
  <link rel="alternate" type="application/atom+xml" href="/atom.xml">
  <script>
    (function(i, s, o, g, r, a, m) {
      i['GoogleAnalyticsObject'] = r;
      i[r] = i[r] || function() {
        (i[r].q = i[r].q || []).push(arguments)
      }, i[r].l = 1 * new Date();
      a = s.createElement(o),
        m = s.getElementsByTagName(o)[0];
      a.async = 1;
      a.src = g;
      m.parentNode.insertBefore(a, m)
    })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');
    ga('create', 'UA-86170223-1', 'auto');
    ga('send', 'pageview');
  </script>
</head>

<body>
  <div class="body_container">
    <div id="header">
      <div class="site-name">
        <h1 class="hidden">Scrapy学习日记 一 · run many spiders</h1><a id="logo" href="/.">linw1995</a>
        <p class="description"></p>
      </div>
      <div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> Home</i></a><a href="/archives/"><i class="fa fa-archive"> Archive</i></a><a href="/about/"><i class="fa fa-user"> About</i></a><a href="/atom.xml"><i class="fa fa-rss"> RSS</i></a></div>
    </div>
    <div id="layout" class="pure-g">
      <div class="pure-u-1 pure-u-md-4-4">
        <div class="content_container">
          <div class="post">
            <h1 class="post-title">Scrapy学习日记 一 · run many spiders</h1>
            <div class="post-meta">Apr 15, 2017<span> | </span><span class="category"><a href="/categories/Python/">Python</a></span>
              <script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span>
            </div>
            <a data-disqus-identifier="2017/04/15/Scrapy学习日记-一-·-run-many-spiders/" href="/2017/04/15/Scrapy学习日记-一-·-run-many-spiders/#disqus_thread" class="disqus-comment-count"></a>
            <div class="clear">
              <div id="toc" class="toc-article">
                <div class="toc-title">Contents</div>
                <ol class="toc">
                  <li class="toc-item toc-level-1"><a class="toc-link" href="#template-自定模板"><span class="toc-number">1.</span> <span class="toc-text">
  template 自定模板</span></a></li>
                  <li class="toc-item toc-level-1"><a class="toc-link" href="#command-自定命令"><span class="toc-number">2.</span> <span class="toc-text">
  command 自定命令</span></a></li>
                  <li class="toc-item toc-level-1"><a class="toc-link" href="#job-Spider的暂停-恢复"><span class="toc-number">3.</span> <span class="toc-text">
  job Spider的暂停\恢复</span></a></li>
                  <li class="toc-item toc-level-1"><a class="toc-link" href="#结论"><span class="toc-number">4.</span> <span class="toc-text">
  结论</span></a></li>
                  <li class="toc-item toc-level-1"><a class="toc-link" href="#Scrapy学习日记"><span class="toc-number">5.</span> <span class="toc-text">
  Scrapy学习日记</span></a></li>
                </ol>
              </div>
            </div>
            <div class="post-content">
              <p>这两周都在学习使用这个爬虫框架，略有收获。<br>把一些小技巧分享给大家。<br>
                <a id="more"></a>
              </p>
              <h1 id="template-自定模板">
                <a href="#template-自定模板" class="headerlink" title="template 自定模板"></a>template 自定模板</h1>
              <p>用过<strong>Scrapy</strong>的人都知道，有生成<strong>Spider</strong>的命令</p>
              <pre><code>scrapy genspider mydomain mydomain.com
</code></pre>
              <p>其实我们可以自定模板，然后一样通过这个命令生成出爬虫。</p>
              <!-- markdownlint-disable MD022 MD012 -->
              <figure class="highlight plain">
                <table>
                  <tr>
                    <td class="gutter">
                      <pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre> </td>
                    <td class="code">
                      <pre><div class="line"># common.tmpl</div><div class="line"># -*- coding: utf-8 -*-</div><div class="line">import scrapy</div><div class="line"></div><div class="line"></div><div class="line">class $classname(scrapy.Spider):</div><div class="line">    name = &quot;$name&quot;</div><div class="line">    allowed_domains = [&quot;$domain&quot;]</div><div class="line">    start_urls = [&apos;http://$domain/&apos;]</div><div class="line"></div><div class="line">    def parse(self, response):</div><div class="line">        pass</div></pre> </td>
                  </tr>
                </table>
              </figure>
              <!-- markdownlint-enable MD022 MD012-->
              <p>在根目录下创建新的文件夹来存放自定模板,再把写好的common.tmpl保存到里面</p>
              <pre><code>scrapy.cfg
myprojec/
    __init__.py
    items.py
    pipelines.py
    settings.py
    templates/
        spiders/
            common.tmpl
    spiders/
        __init__.py
        spider1.py
        spider2.py
        ...
</code></pre>
              <p>然后修改设置，添加TEMPLATES_DIR<br>
                <!-- markdownlint-disable MD022 MD026 -->
              </p>
              <figure class="highlight python">
                <table>
                  <tr>
                    <td class="gutter">
                      <pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre> </td>
                    <td class="code">
                      <pre><div class="line"><span class="comment"># settings.py</span></div><div class="line"><span class="comment"># -*- coding:utf-8 -*-</span></div><div class="line"><span class="keyword">from</span> os <span class="keyword">import</span> path</div><div class="line"><span class="comment"># ...</span></div><div class="line"></div><div class="line">basedir = os.path.dirname(__file__)</div><div class="line">TEMPLATES_DIR = os.path.abspath os.path.join(basedir, <span class="string">'templates'</span>))</div><div class="line"><span class="comment"># ...</span></div></pre> </td>
                  </tr>
                </table>
              </figure>
              <!-- markdownlint-enable MD022 MD026-->
              <p>然后即可使用该命令生成<strong>Spider</strong>了</p>
              <pre><code>scrapy genspider -t common mydomain mydomain.com
</code></pre>
              <h1 id="command-自定命令">
                <a href="#command-自定命令" class="headerlink" title="command 自定命令"></a>command 自定命令</h1>
              <p>用<strong>template</strong>模板生成了大量的<strong>Spider</strong>,想要用一个命令让他们一起运行怎么办。<br>通过自定<strong>command</strong>,满足你的</p>
              <!-- markdownlint-disable MD022 MD026 MD012 -->
              <figure class="highlight python">
                <table>
                  <tr>
                    <td class="gutter">
                      <pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre> </td>
                    <td class="code">
                      <pre><div class="line"><span class="comment"># runallspider.py</span></div><div class="line"><span class="comment"># -*- coding:utf-8 -*-</span></div><div class="line"><span class="keyword">from</span> scrapy.commands <span class="keyword">import</span> ScrapyCommand</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Command</span><span class="params">(ScrapyCommand)</span>:</span></div><div class="line"></div><div class="line">    requires_project = <span class="keyword">True</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">syntax</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">return</span> <span class="string">'[options]'</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">short_desc</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">return</span> <span class="string">'Runs all of the spiders'</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self, args, opts)</span>:</span></div><div class="line">        <span class="keyword">for</span> spider_name <span class="keyword">in</span> self.crawler_process.spider_loader.list():</div><div class="line">            self.crawler_process.crawl(spider_name)</div><div class="line">        self.crawler_process.start()</div></pre> </td>
                  </tr>
                </table>
              </figure>
              <!-- markdownlint-enable MD022 MD026 MD012 -->
              <p>也同<strong>template</strong>一样，在根目录下创建一文件夹commands，把写好的runallspider.py保存到里面去<br>然后修改设置，添加COMMANDS_MODULE<br>
                <!-- markdownlint-disable MD022 MD026 -->
              </p>
              <figure class="highlight python">
                <table>
                  <tr>
                    <td class="gutter">
                      <pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre> </td>
                    <td class="code">
                      <pre><div class="line"><span class="comment"># settings.py</span></div><div class="line"><span class="comment"># ...</span></div><div class="line">COMMANDS_MODULE = <span class="string">'myproject.commands'</span></div><div class="line"><span class="comment"># ...</span></div></pre> </td>
                  </tr>
                </table>
              </figure>
              <!-- markdownlint-enable MD022 MD026 -->
              <p>然后即可使用该命令同时运行所有<strong>Spider</strong>了</p>
              <pre><code>scrapy runallspider
</code></pre>
              <h1 id="job-Spider的暂停-恢复">
                <a href="#job-Spider的暂停-恢复" class="headerlink" title="job Spider的暂停\恢复"></a>job Spider的暂停\恢复</h1>
              <p>和<strong>Linux</strong>系统下的<strong>job</strong>命令类似，用来保存<strong>Spider</strong>状态，以下次启动<strong>Spider</strong>来恢复之前的保存的爬取状态</p>
              <p>首先要修改设置，添加JOBDIR<br>
                <!-- markdownlint-disable MD022 MD026 -->
              </p>
              <figure class="highlight python">
                <table>
                  <tr>
                    <td class="gutter">
                      <pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre> </td>
                    <td class="code">
                      <pre><div class="line"><span class="comment"># settings.py</span></div><div class="line"><span class="comment"># ...</span></div><div class="line">JOBDIR = os.path.abspath os.path.join(basedir, <span class="string">'jobs'</span>))</div><div class="line"><span class="comment"># ...</span></div></pre> </td>
                  </tr>
                </table>
              </figure>
              <!-- markdownlint-enable MD022 MD026 -->
              <p>然后像往常一样运行爬虫即可，也可以通过重载设置来临时使用</p>
              <pre><code>scrapy crawl spider -s JOBDIR=jobs/spider
</code></pre>
              <p>爬虫暂停后，也是通过以上命令恢复到之前保存的状态</p>
              <p>可是现在我们运行<code>scrapy runallspider</code>命令就会出错，这是因为<strong>Scrapy</strong>设计时只考虑运行单例<strong>Spider</strong><br>我们只需对存储<strong>Spider</strong>状态的类代码进行修改，使其能满足我们的要求</p>
              <!-- markdownlint-disable MD022 MD026 MD012 -->
              <figure class="highlight python">
                <table>
                  <tr>
                    <td class="gutter">
                      <pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div></pre> </td>
                    <td class="code">
                      <pre><div class="line"><span class="comment"># ext/__init__.py</span></div><div class="line"><span class="comment"># -*- coding: utf - 8 - *-</span></div><div class="line"><span class="keyword">import</span> logging</div><div class="line"><span class="keyword">import</span> os</div><div class="line"><span class="keyword">import</span> pickle</div><div class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> defaultdict</div><div class="line"><span class="keyword">from</span> twisted.internet <span class="keyword">import</span> task</div><div class="line"></div><div class="line"><span class="keyword">from</span> scrapy.core.scheduler <span class="keyword">import</span> Scheduler <span class="keyword">as</span> SchedulerBase</div><div class="line"><span class="keyword">from</span> scrapy.dupefilters <span class="keyword">import</span> RFPDupeFilter <span class="keyword">as</span> RFPDupeFilterBase</div><div class="line"><span class="keyword">from</span> scrapy.extensions.logstats <span class="keyword">import</span> LogStats <span class="keyword">as</span> LogStatsBase</div><div class="line"><span class="keyword">from</span> scrapy.extensions.spiderstate <span class="keyword">import</span> SpiderState <span class="keyword">as</span> SpiderStateBase</div><div class="line"><span class="keyword">from</span> scrapy.utils.job <span class="keyword">import</span> job_dir</div><div class="line"><span class="keyword">from</span> scrapy.utils.misc <span class="keyword">import</span> load_object</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">StatsCollector</span>:</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, crawler)</span>:</span></div><div class="line">        self._dump = crawler.settings.getbool(<span class="string">'STATS_DUMP'</span>)</div><div class="line">        self._stats = defaultdict(dict)</div><div class="line">        self.jobdir = job_dir(crawler.settings)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_value</span><span class="params">(self, key, default=None, spider=None)</span>:</span></div><div class="line">        <span class="keyword">return</span> self._stats[spider.name <span class="keyword">if</span> spider <span class="keyword">else</span> <span class="keyword">None</span>].get(key, default)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_stats</span><span class="params">(self, spider=None)</span>:</span></div><div class="line">        <span class="keyword">return</span> self._stats[spider.name <span class="keyword">if</span> spider <span class="keyword">else</span> <span class="keyword">None</span>]</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_all_stats</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">return</span> self._stats</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">set_value</span><span class="params">(self, key, value, spider=None)</span>:</span></div><div class="line">        self._stats[spider.name <span class="keyword">if</span> spider <span class="keyword">else</span> <span class="keyword">None</span>][key] = value</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">set_stats</span><span class="params">(self, stats, spider=None)</span>:</span></div><div class="line">        self._stats[spider.name <span class="keyword">if</span> spider <span class="keyword">else</span> <span class="keyword">None</span>] = stats</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">inc_value</span><span class="params">(self, key, count=<span class="number">1</span>, start=<span class="number">0</span>, spider=None)</span>:</span></div><div class="line">        d = self._stats[spider.name <span class="keyword">if</span> spider <span class="keyword">else</span> <span class="keyword">None</span>]</div><div class="line">        d[key] = d.setdefault(key, start) + count</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">max_value</span><span class="params">(self, key, value, spider=None)</span>:</span></div><div class="line">        d = self._stats[spider.name <span class="keyword">if</span> spider <span class="keyword">else</span> <span class="keyword">None</span>]</div><div class="line">        d[key] = max(d.setdefault(key, value), value)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">min_value</span><span class="params">(self, key, value, spider=None)</span>:</span></div><div class="line">        d = self._stats[spider.name <span class="keyword">if</span> spider <span class="keyword">else</span> <span class="keyword">None</span>]</div><div class="line">        d[key] = min(d.setdefault(key, value), value)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">clear_stats</span><span class="params">(self, spider=None)</span>:</span></div><div class="line">        self._stats[spider.name <span class="keyword">if</span> spider <span class="keyword">else</span> <span class="keyword">None</span>].clear()</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">clear_all_stats</span><span class="params">(self)</span>:</span></div><div class="line">        self._stats.clear()</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">open_spider</span><span class="params">(self, spider)</span>:</span></div><div class="line">        loadpath = os.path.join(self.jobdir, <span class="string">'stats'</span>)</div><div class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(loadpath):</div><div class="line">            <span class="keyword">return</span></div><div class="line">        <span class="keyword">with</span> open(loadpath, <span class="string">'rb'</span>) <span class="keyword">as</span> f:</div><div class="line">            self._stats = pickle.load(f)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">close_spider</span><span class="params">(self, spider, reason)</span>:</span></div><div class="line">        dumppath = os.path.join(self.jobdir, <span class="string">'stats'</span>)</div><div class="line">        <span class="keyword">with</span> open(dumppath, <span class="string">'wb'</span>) <span class="keyword">as</span> f:</div><div class="line">            pickle.dump(self._stats, f)</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">SpiderState</span><span class="params">(SpiderStateBase)</span>:</span></div><div class="line"><span class="meta">    @property</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">statefn</span><span class="params">(self)</span>:</span></div><div class="line">        statedir = os.path.join(</div><div class="line">            self.jobdir,</div><div class="line">            self.spider_name) <span class="keyword">if</span> self.spider_name <span class="keyword">else</span> self.jobdir</div><div class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(statedir):</div><div class="line">            os.makedirs(statedir)</div><div class="line">        <span class="keyword">return</span> os.path.join(statedir, <span class="string">'spider.state'</span>)</div><div class="line"></div><div class="line"><span class="meta">    @classmethod</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">from_crawler</span><span class="params">(cls, crawler)</span>:</span></div><div class="line">        obj = super(SpiderState, cls).from_crawler(crawler)</div><div class="line">        obj.spider_name = crawler.spidercls.name <span class="keyword">if</span> crawler.spidercls <span class="keyword">else</span> <span class="keyword">None</span></div><div class="line">        <span class="keyword">return</span> obj</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Scheduler</span><span class="params">(SchedulerBase)</span>:</span></div><div class="line"></div><div class="line"><span class="meta">    @classmethod</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">from_crawler</span><span class="params">(cls, crawler)</span>:</span></div><div class="line">        settings = crawler.settings</div><div class="line">        dupefilter_cls = load_object(settings[<span class="string">'DUPEFILTER_CLASS'</span>])</div><div class="line">        dupefilter = dupefilter_cls.from_crawler(crawler)</div><div class="line">        pqclass = load_object(settings[<span class="string">'SCHEDULER_PRIORITY_QUEUE'</span>])</div><div class="line">        dqclass = load_object(settings[<span class="string">'SCHEDULER_DISK_QUEUE'</span>])</div><div class="line">        mqclass = load_object(settings[<span class="string">'SCHEDULER_MEMORY_QUEUE'</span>])</div><div class="line">        logunser = settings.getbool(</div><div class="line">            <span class="string">'LOG_UNSERIALIZABLE_REQUESTS'</span>, settings.getbool(<span class="string">'SCHEDULER_DEBUG'</span>))</div><div class="line">        obj = cls(dupefilter, jobdir=job_dir(settings),</div><div class="line">                  logunser=logunser, stats=crawler.stats,</div><div class="line">                  pqclass=pqclass, dqclass=dqclass, mqclass=mqclass)</div><div class="line"></div><div class="line">        <span class="keyword">if</span> crawler.spidercls:</div><div class="line">            obj.spider_name = crawler.spidercls.name</div><div class="line">            obj.dqdir = obj._dqdir(job_dir(settings))</div><div class="line">        <span class="keyword">return</span> obj</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_dqdir</span><span class="params">(self, jobdir)</span>:</span></div><div class="line">        <span class="keyword">if</span> jobdir:</div><div class="line">            jobdir = os.path.join(</div><div class="line">                jobdir, self.spider_name) \</div><div class="line">                <span class="keyword">if</span> hasattr(self, <span class="string">'spider_name'</span>) <span class="keyword">else</span> jobdir</div><div class="line">            dqdir = os.path.join(jobdir, <span class="string">'requests.queue'</span>)</div><div class="line">            <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(dqdir):</div><div class="line">                os.makedirs(dqdir)</div><div class="line">            <span class="keyword">return</span> dqdir</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">RFPDupeFilter</span><span class="params">(RFPDupeFilterBase)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, path=None, debug=False, spider_name=None)</span>:</span></div><div class="line">        super(RFPDupeFilter, self).__init__(path=<span class="keyword">None</span>, debug=debug)</div><div class="line">        <span class="keyword">if</span> path:</div><div class="line">            <span class="keyword">if</span> spider_name:</div><div class="line">                path = os.path.join(path, spider_name)</div><div class="line">                <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(path):</div><div class="line">                    os.makedirs(path)</div><div class="line">            path = os.path.join(path, <span class="string">'requests.seen'</span>)</div><div class="line">            self.file = open(path, <span class="string">'a+'</span>)</div><div class="line">            self.file.seek(<span class="number">0</span>)</div><div class="line">            self.fingerprints.update(x.rstrip() <span class="keyword">for</span> x <span class="keyword">in</span> self.file)</div><div class="line"></div><div class="line"><span class="meta">    @classmethod</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">from_crawler</span><span class="params">(cls, crawler)</span>:</span></div><div class="line">        settings = crawler.settings</div><div class="line">        debug = settings.getbool(<span class="string">'BUPEFILTER_DEBUG'</span>)</div><div class="line">        <span class="keyword">return</span> cls(job_dir(settings), debug,</div><div class="line">                   crawler.spidercls.name <span class="keyword">if</span> crawler.spidercls <span class="keyword">else</span> <span class="keyword">None</span>)</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">LogStats</span><span class="params">(LogStatsBase)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">spider_opened</span><span class="params">(self, spider)</span>:</span></div><div class="line">        self.itemsprev = self.stats.get_value(</div><div class="line">            <span class="string">'item_scraped_count'</span>, <span class="number">0</span>, spider)</div><div class="line">        self.pagesprev = self.stats.get_value(</div><div class="line">            <span class="string">'response_received_count'</span>, <span class="number">0</span>, spider)</div><div class="line"></div><div class="line">        self.task = task.LoopingCall(self.log, spider)</div><div class="line">        self.task.start(self.interval)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">log</span><span class="params">(self, spider)</span>:</span></div><div class="line">        LogStatslogger = logging.getLogger(spider.name)</div><div class="line"></div><div class="line">        items = self.stats.get_value(<span class="string">'item_scraped_count'</span>, <span class="number">0</span>, spider)</div><div class="line">        pages = self.stats.get_value(<span class="string">'response_received_count'</span>, <span class="number">0</span>, spider)</div><div class="line">        irate = (items - self.itemsprev) * self.multiplier</div><div class="line">        prate = (pages - self.pagesprev) * self.multiplier</div><div class="line">        self.pagesprev, self.itemsprev = pages, items</div><div class="line"></div><div class="line">        msg = (<span class="string">"Crawled %(pages)d pages (at %(pagerate)d pages/min), "</span></div><div class="line">               <span class="string">"scraped %(items)d items (at %(itemrate)d items/min)"</span>)</div><div class="line">        log_args = &#123;<span class="string">'pages'</span>: pages, <span class="string">'pagerate'</span>: prate,</div><div class="line">                    <span class="string">'items'</span>: items, <span class="string">'itemrate'</span>: irate&#125;</div><div class="line">        LogStatslogger.info(msg, log_args, extra=&#123;<span class="string">'spider'</span>: spider&#125;)</div></pre> </td>
                  </tr>
                </table>
              </figure>
              <!-- markdownlint-enable MD022 MD026 MD012 -->
              <p>把以上代码保存到根目录下的<code>ext\__init__.py</code>中，最后修改设置<br>
                <!-- markdownlint-disable MD022 MD026 -->
              </p>
              <figure class="highlight python">
                <table>
                  <tr>
                    <td class="gutter">
                      <pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre> </td>
                    <td class="code">
                      <pre><div class="line"><span class="comment"># settings.py...</span></div><div class="line">DUPEFILTER_CLASS = <span class="string">'myproject.ext.RFPDupeFilter'</span></div><div class="line">SCHEDULER = <span class="string">'myproject.ext.Scheduler'</span></div><div class="line">EXTENSIONS_BASE = &#123;</div><div class="line">    <span class="string">'myproject.ext.LogStats'</span>: <span class="number">0</span>,</div><div class="line">    <span class="string">'myproject.ext.SpiderState'</span>: <span class="number">0</span>,</div><div class="line">    <span class="string">'scrapy.extensions.corestats.CoreStats'</span>: <span class="number">0</span>,</div><div class="line">    <span class="string">'scrapy.extensions.telnet.TelnetConsole'</span>: <span class="number">0</span>,</div><div class="line">    <span class="string">'scrapy.extensions.memusage.MemoryUsage'</span>: <span class="number">0</span>,</div><div class="line">    <span class="string">'scrapy.extensions.memdebug.MemoryDebugger'</span>: <span class="number">0</span>,</div><div class="line">    <span class="string">'scrapy.extensions.closespider.CloseSpider'</span>: <span class="number">0</span>,</div><div class="line">    <span class="string">'scrapy.extensions.feedexport.FeedExporter'</span>: <span class="number">0</span>,</div><div class="line">    <span class="string">'scrapy.extensions.throttle.AutoThrottle'</span>: <span class="number">0</span>,</div><div class="line">&#125;</div><div class="line"><span class="comment"># ...</span></div></pre> </td>
                  </tr>
                </table>
              </figure>
              <!-- markdownlint-enable MD022 MD026 -->
              <p>现在运行<code>scrapy runallspider</code>就没问题了，暂停，等下次重新启动也就能恢复到原来的爬虫状态。</p>
              <h1 id="结论">
                <a href="#结论" class="headerlink" title="结论"></a>结论</h1>
              <p><strong>Scrapy</strong>是一个十分强大且支持扩展的爬虫框架</p>
              <ol>
                <li><strong>template</strong>模板,让我们少写了许多代码;</li>
                <li><strong>command</strong>自定命令,让我们可以偷懒 :) ；</li>
                <li><strong>job</strong> <strong>Spider</strong>的暂停\恢复,这个功能太强大了。<br> 不仅只是保存<strong>Spider</strong>这几类状态，比如说通过重载<strong>pipeline</strong>中的<br><code>open_spider(spider)</code>和<code>closed_spider(spider)</code>方法,来保存<strong>pipeline</strong>的状态，以供下次恢复</li>
              </ol>
              <h1 id="Scrapy学习日记">
                <a href="#Scrapy学习日记" class="headerlink" title="Scrapy学习日记"></a>Scrapy学习日记</h1>
              <blockquote class="pullquote">
                <ol>
                  <li><a href="/2017/04/15/Scrapy学习日记-一-·-run-many-spiders/" title="Scrapy学习日记 一 · run many spiders">Scrapy学习日记 一 · run many spiders</a></li>
                  <li><a href="/2017/04/23/Scrapy学习日记-二-·-Selenium-PhantomJS/" title="Scrapy学习日记 二 · Selenium+PhantomJS">Scrapy学习日记 二 · Selenium+PhantomJS</a></li>
                </ol>
              </blockquote>
            </div>
            <script type="text/javascript" src="/js/share.js?v=0.0.2" async></script><a data-url="http://linw1995.com/2017/04/15/Scrapy学习日记-一-·-run-many-spiders/" data-id="cj2u56hoz000cx0itqef0klg2" class="article-share-link">Share</a>
            <div class="tags"><a href="/tags/Python/">Python</a><a href="/tags/Scrapy/">Scrapy</a></div>
            <div class="post-nav"><a href="/2017/04/17/分享-Way-Back-Into-Love-Haley-Bennett-Hugh-Grant/" class="pre">分享 Way Back Into Love - Haley Bennett/Hugh Grant</a><a href="/2017/04/12/折腾VSCode记-二-·-Settings-Sync/" class="next">折腾VSCode记 二 · Settings Sync</a></div>
            <div
              id="disqus_thread">
              <div class="btn_click_load"><button class="disqus_click_btn">阅读评论 「请确保 disqus.com 可以正常加载」</button></div>
              <script>
                var disqus_shortname = 'linw1995';
                var disqus_identifier = '2017/04/15/Scrapy学习日记-一-·-run-many-spiders/';
                var disqus_title = 'Scrapy学习日记 一 · run many spiders';
                var disqus_url = 'http://linw1995.com/2017/04/15/Scrapy学习日记-一-·-run-many-spiders/';
                $('.btn_click_load').click(function() {
                  (function() {
                    var dsq = document.createElement('script');
                    dsq.type = 'text/javascript';
                    dsq.async = true;
                    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                  })();
                  $('.btn_click_load').css('display', 'none');
                });
                $.ajax({
                  url: 'https://disqus.com/favicon.ico',
                  timeout: 3000,
                  type: 'GET',
                  success: (function() {
                    var dsq = document.createElement('script');
                    dsq.type = 'text/javascript';
                    dsq.async = true;
                    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                    $('.btn_click_load').css('display', 'none');
                  })(),
                  error: function() {
                    $('.btn_click_load').css('display', 'block');
                  }
                });
              </script>
              <script id="dsq-count-scr" src="//linw1995.disqus.com/count.js" async></script>
          </div>
        </div>
      </div>
    </div>
    <div class="pure-u-1 pure-u-md-4-4">
      <div id="footer">Copyright © 2017 <a href="/." rel="nofollow">linw1995.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow"
          target="_blank" href="https://github.com/pagecho"> Cho.</a></div>
    </div>
  </div>
  <a id="rocket" href="#top" class="show"></a>
  <script type="text/javascript" src="/js/totop.js?v=0.0.2" async></script>
  <script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.js" async></script>
  <script type="text/javascript" src="/js/fancybox.js?v=0.0.2" async></script>
  <link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.css">
  <script type="text/javascript" src="/js/search.js?v=0.0.2"></script>
  <script>
    var search_path = 'search.xml';
    if (search_path.length == 0) {
      search_path = 'search.xml';
    }
    var path = '/' + search_path;
    searchFunc(path, 'local-search-input', 'local-search-result');
  </script>
  <script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.2"></script>
  <script type="text/javascript" src="/js/smartresize.js?v=0.0.2"></script>
  </div>
</body>

</html>