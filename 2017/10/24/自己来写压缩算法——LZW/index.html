<!DOCTYPE html>
<html lang="en">

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
  <meta content="yes" name="apple-mobile-web-app-capable">
  <meta content="black-translucent" name="apple-mobile-web-app-status-bar-style">
  <meta content="telephone=no" name="format-detection">
  <meta name="description" content="Personal Blog">
  <title>自己来写压缩算法——LZW | linw1995</title>
  <link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0">
  <link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/6.0.0/normalize.min.css">
  <link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/pure-min.css">
  <link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/grids-responsive-min.css">
  <link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css">
  <script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
  <link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  <link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png">
  <link rel="alternate" type="application/atom+xml" href="/atom.xml">
  <script>
    (function(i, s, o, g, r, a, m) {
      i['GoogleAnalyticsObject'] = r;
      i[r] = i[r] || function() {
        (i[r].q = i[r].q || []).push(arguments)
      }, i[r].l = 1 * new Date();
      a = s.createElement(o),
        m = s.getElementsByTagName(o)[0];
      a.async = 1;
      a.src = g;
      m.parentNode.insertBefore(a, m)
    })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');
    ga('create', 'UA-86170223-1', 'auto');
    ga('send', 'pageview');
  </script>
</head>

<body>
  <div class="body_container">
    <div id="header">
      <div class="site-name">
        <h1 class="hidden">自己来写压缩算法——LZW</h1><a id="logo" href="/.">linw1995</a>
        <p class="description"></p>
      </div>
      <div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> Home</i></a><a href="/archives/"><i class="fa fa-archive"> Archive</i></a><a href="/about/"><i class="fa fa-user"> About</i></a><a href="/atom.xml"><i class="fa fa-rss"> RSS</i></a></div>
    </div>
    <div id="layout" class="pure-g">
      <div class="pure-u-1 pure-u-md-4-4">
        <div class="content_container">
          <div class="post">
            <h1 class="post-title">自己来写压缩算法——LZW</h1>
            <div class="post-meta">Oct 24, 2017<span> | </span><span class="category"><a href="/categories/Algorithms/">Algorithms</a></span>
              <script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span>
            </div><a data-disqus-identifier="2017/10/24/自己来写压缩算法——LZW/" href="/2017/10/24/自己来写压缩算法——LZW/#disqus_thread" class="disqus-comment-count"></a>
            <div class="clear">
              <div id="toc" class="toc-article">
                <div class="toc-title">Contents</div>
                <ol class="toc">
                  <li class="toc-item toc-level-2"><a class="toc-link" href="#LZW"><span class="toc-number">1.</span> <span class="toc-text">LZW</span></a></li>
                  <li class="toc-item toc-level-2"><a class="toc-link" href="#原理"><span class="toc-number">2.</span> <span class="toc-text">原理</span></a>
                    <ol class="toc-child">
                      <li class="toc-item toc-level-3"><a class="toc-link" href="#编码"><span class="toc-number">2.1.</span> <span class="toc-text">编码</span></a></li>
                      <li class="toc-item toc-level-3"><a class="toc-link" href="#解码"><span class="toc-number">2.2.</span> <span class="toc-text">解码</span></a></li>
                    </ol>
                  </li>
                  <li class="toc-item toc-level-2"><a class="toc-link" href="#实现"><span class="toc-number">3.</span> <span class="toc-text">实现</span></a>
                    <ol class="toc-child">
                      <li class="toc-item toc-level-3"><a class="toc-link" href="#核心代码"><span class="toc-number">3.1.</span> <span class="toc-text">核心代码</span></a></li>
                      <li class="toc-item toc-level-3"><a class="toc-link" href="#读写文件"><span class="toc-number">3.2.</span> <span class="toc-text">读写文件</span></a></li>
                      <li class="toc-item toc-level-3"><a class="toc-link" href="#动态编码长度"><span class="toc-number">3.3.</span> <span class="toc-text">动态编码长度</span></a></li>
                    </ol>
                  </li>
                  <li class="toc-item toc-level-2"><a class="toc-link" href="#完整代码"><span class="toc-number">4.</span> <span class="toc-text">完整代码</span></a></li>
                  <li class="toc-item toc-level-2"><a class="toc-link" href="#参考"><span class="toc-number">5.</span> <span class="toc-text">参考</span></a></li>
                </ol>
              </div>
            </div>
            <div class="post-content">
              <p>之前用<a href="/2017/09/24/自己来写压缩算法——哈夫曼算法/" title="哈夫曼算法">哈夫曼算法</a>，把<strong>固定长</strong>的字符编码根据其出现次数，编码为<strong>不固定长</strong>的编码。而这次介绍的算法恰恰相反，该算法是把<strong>不等长</strong>的字符串，编码为<strong>固定长</strong>的编码。</p>
              <h2 id="LZW"><a href="#LZW" class="headerlink" title="LZW"></a>LZW</h2>
              <p>蓝博-立夫-卫曲编码法（Lempel-Ziv-Welch，缩写LZW），是亚伯拉罕·蓝波、杰可布·立夫与泰瑞·卫曲共同提出的一种无损数据压缩演算法。与<a href="https://zh.wikipedia.org/wiki/%E9%9C%8D%E5%A4%AB%E6%9B%BC%E7%BC%96%E7%A0%81" target="_blank" rel="external">霍夫曼编码</a>相比，LZW把不同长度的字符串转换为固定长的编码。该方法不需要事先对数据做任何分析，所以可以流式地对文件进行处理。</p>
              <h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2>
              <h3 id="编码"><a href="#编码" class="headerlink" title="编码"></a>编码</h3>
              <p>首先先将单字符建立成一个字符串编码表，分别给予编号。</p>
              <figure class="highlight plain">
                <table>
                  <tr>
                    <td class="gutter">
                      <pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre> </td>
                    <td class="code">
                      <pre><div class="line">| string | code |</div><div class="line">|--------|------|</div><div class="line">| a      | 1    |</div><div class="line">| b      | 2    |</div><div class="line">| c      | 3    |</div></pre> </td>
                  </tr>
                </table>
              </figure>
              <p>若数据为<code>aabcaac</code>，进过LZW编码后结果为<code>112343</code>，过程如下</p>
              <figure class="highlight plain">
                <table>
                  <tr>
                    <td class="gutter">
                      <pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre> </td>
                    <td class="code">
                      <pre><div class="line">| No. | cur | prefix | prefix in str-&gt;code | code | str-&gt;code |</div><div class="line">|-----|-----|--------|---------------------|------|-----------|</div><div class="line">| 1   | a   |        |                     |      |           |</div><div class="line">| 2   | a   | a      | 1                   |      |           |</div><div class="line">| 3   | b   | aa     | 0                   | 1    | aa -&gt; 4   |</div><div class="line">| 4   | c   | ab     | 0                   | 1    | ab -&gt; 5   |</div><div class="line">| 5   | a   | bc     | 0                   | 2    | bc -&gt; 6   |</div><div class="line">| 6   | a   | ca     | 0                   | 3    | ca -&gt; 7   |</div><div class="line">| 7   | c   | aa     | 1                   |      |           |</div><div class="line">| 8   |     | aac    | 0                   | 4    | aac -&gt; 8  |</div><div class="line">| 9   |     | c      | 1                   | 3    |           |</div></pre> </td>
                  </tr>
                </table>
              </figure>
              <p>整个算法过程如下：</p>
              <ol>
                <li>取一个字符c</li>
                <li>若字符串p + 字符c <strong>在</strong> 字符串编码表中，字符串p += 字符c</li>
                <li>若字符串p + 字符c <strong>不在</strong> 字符串编码表中：
                  <ol>
                    <li>获取 字符串p 的编码</li>
                    <li>将 字符串p + 字符c 存入字符串编码表</li>
                    <li>字符串p = 字符c</li>
                  </ol>
                </li>
                <li>重复以上步骤</li>
                <li>最后 获取 字符串p 的编码</li>
              </ol>
              <h3 id="解码"><a href="#解码" class="headerlink" title="解码"></a>解码</h3>
              <p>一开始的字符串编码都是同一个，那么如何把<code>112343</code>解码为<code>aabcaac</code>？</p>
              <figure class="highlight plain">
                <table>
                  <tr>
                    <td class="gutter">
                      <pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre> </td>
                    <td class="code">
                      <pre><div class="line">| string | code |</div><div class="line">|--------|------|</div><div class="line">| a      | 1    |</div><div class="line">| b      | 2    |</div><div class="line">| c      | 3    |</div></pre> </td>
                  </tr>
                </table>
              </figure>
              <p>解码过程如下：</p>
              <figure class="highlight plain">
                <table>
                  <tr>
                    <td class="gutter">
                      <pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre> </td>
                    <td class="code">
                      <pre><div class="line">| No. | cur | str | prefix | prefix in str-&gt;code | str-&gt;code |</div><div class="line">|-----|-----|-----|--------|---------------------|-----------|</div><div class="line">| 1   | 1   | a   |        |                     |           |</div><div class="line">| 2   | 1   | a   | a      | 1                   |           |</div><div class="line">| 3   | 2   | b   | aa     | 0                   | aa -&gt; 4   |</div><div class="line">| 4   | 3   | c   | ab     | 0                   | ab -&gt; 5   |</div><div class="line">| 5   | 4   | aa  | bc     | 0                   | bc -&gt; 6   |</div><div class="line">| 6   |     | a   | ca     | 0                   | ca -&gt; 7   |</div><div class="line">| 7   | 3   | c   | aa     | 1                   |           |</div><div class="line">| 8   |     |     | aac    | 0                   | aac -&gt; 8  |</div></pre> </td>
                  </tr>
                </table>
              </figure>
              <p>整个算法过程如下：</p>
              <ol>
                <li>取一个编码k</li>
                <li>对照 字符串编码表 取得字符串cs
                  <ol>
                    <li>从字符串cs中取得字符c</li>
                    <li>若字符串p + 字符c <strong>在</strong> 字符串编码表中，字符串p += 字符c</li>
                    <li>若字符串p + 字符c <strong>不在</strong> 字符串编码表中：
                      <ol>
                        <li>将 字符串p + 字符c 存入字符串编码表</li>
                        <li>字符串p = 字符c</li>
                      </ol>
                    </li>
                    <li>重复以上步骤</li>
                  </ol>
                </li>
                <li>重复以上步骤</li>
              </ol>
              <h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2>
              <h3 id="核心代码"><a href="#核心代码" class="headerlink" title="核心代码"></a>核心代码</h3>
              <p>照着算法步骤，我们很容易地写出以下的代码：</p>
              <figure class="highlight python">
                <table>
                  <tr>
                    <td class="gutter">
                      <pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre> </td>
                    <td class="code">
                      <pre><div class="line"><span class="keyword">from</span> six <span class="keyword">import</span> int2byte</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment"># 初始字符串编码表</span></div><div class="line"><span class="comment"># str  -&gt; code</span></div><div class="line">original_cdict = &#123;<span class="string">b'a'</span>: <span class="number">0</span>, <span class="string">b'b'</span>: <span class="number">1</span>, <span class="string">b'c'</span>: <span class="number">2</span>&#125;</div><div class="line"><span class="comment"># code -&gt; str</span></div><div class="line">original_kdict = [<span class="string">b'a'</span>, <span class="string">b'b'</span>, <span class="string">b'c'</span>]</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">encode</span><span class="params">(data)</span>:</span></div><div class="line">    <span class="string">'''</span></div><div class="line"><span class="string">    &gt;&gt;&gt; encode(b'aabcaac')</span></div><div class="line"><span class="string">    [0, 0, 1, 2, 3, 2]</span></div><div class="line"><span class="string">    '''</span></div><div class="line">    cdict = original_cdict.copy()</div><div class="line">    rv = []</div><div class="line">    prefix = <span class="string">b''</span></div><div class="line">    <span class="keyword">for</span> c <span class="keyword">in</span> data:</div><div class="line">        <span class="keyword">if</span> prefix + int2byte(c) <span class="keyword">in</span> cdict:</div><div class="line">            prefix += int2byte(c)</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            rv.append(cdict[prefix])</div><div class="line">            cdict[prefix + int2byte(c)] = len(cdict)</div><div class="line">            prefix = int2byte(c)</div><div class="line">    rv.append(cdict[prefix])</div><div class="line">    <span class="keyword">return</span> rv</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">decode</span><span class="params">(data)</span>:</span></div><div class="line">    <span class="string">'''</span></div><div class="line"><span class="string">    &gt;&gt;&gt; decode([0, 0, 1, 2, 3, 2])</span></div><div class="line"><span class="string">    b'aabcaac'</span></div><div class="line"><span class="string">    '''</span></div><div class="line">    cdict = original_cdict.copy()</div><div class="line">    kdict = original_kdict.copy(</div><div class="line">    prefix = <span class="string">b''</span></div><div class="line">    rv = <span class="string">b''</span></div><div class="line">    <span class="keyword">for</span> key <span class="keyword">in</span> data:</div><div class="line">        cs = kdict[key]</div><div class="line">        <span class="keyword">for</span> c <span class="keyword">in</span> cs:</div><div class="line">            <span class="keyword">if</span> prefix + int2byte(c) <span class="keyword">in</span> cdict:</div><div class="line">                prefix += int2byte(c)</div><div class="line">            <span class="keyword">else</span>:</div><div class="line">                cdict[prefix + int2byte(c)] = len(cdict)</div><div class="line">                kdict.append(prefix + int2byte(c))</div><div class="line">                prefix = int2byte(c)</div><div class="line">        rv += cs</div><div class="line">    <span class="keyword">return</span> rv</div></pre> </td>
                  </tr>
                </table>
              </figure>
              <p>以上就是LZW压缩算法的核心代码。若是要应用到文件上，还是有挺多步要走的。</p>
              <h3 id="读写文件"><a href="#读写文件" class="headerlink" title="读写文件"></a>读写文件</h3>
              <blockquote>
                <p>如何写一个真正实用的压缩程序</p>
              </blockquote>
              <p>要做到压缩、解压缩，如何保存其压缩结果是一个躲避不了的问题。有了之前处理<a href="/2017/09/24/自己来写压缩算法——哈夫曼算法/" title="哈夫曼算法">哈夫曼算法</a>的经验，我们知道要把压缩后的编码列表写入文件过程。先是将其变换成比特流，然后再把比特流写入到文件里。那么一个编码以多少长度写入文件里呢？<br>如果要压缩一个文件，初始字符串编码表长度就是256($2^8$)个。为了使<strong>LZW算法</strong>起到应有的作用，一个编码的长度应该大于8。长度为9,就能保存$2^9
                = 512$个编码；长度为10,就能保存$2^{10} = 1024$个编码；长度为16,就能保存$2^{16} = 65536$个编码。若是选择长度短的，那么怎么压缩大文件呢；若是选择长度长的，那么目标文件更大呢；总不能选个超级长的长度，最后是能压缩大多数文件了，可哪能叫压缩吗（压缩结果大小反而大过源文件）。</p>
              <p>面对这种情况，要增加一个<strong>“哨兵”</strong>。我们以长度16来保存编码，当字符串编码表长度快超过能保存的界限时，重置字符串编码表，从这个位置重新开始算法过程。哈，这个<strong>“哨兵”</strong>值肯定就是$2^{16} - 1 = 65535$。</p>
              <p>新增的压缩处理过程：</p>
              <ol>
                <li>编码结果转换为比特流，再写入文件（如何写入文件）</li>
                <li>设置字符串编码表重置<strong>“哨兵”</strong>值（如何解决字符串编码表无节制增长）</li>
              </ol>
              <p>核心代码加上以上的处理过程，就能写出一个真正实用的压缩程序了！</p>
              <h3 id="动态编码长度"><a href="#动态编码长度" class="headerlink" title="动态编码长度"></a>动态编码长度</h3>
              <blockquote>
                <p>让压缩结果大小再小点</p>
              </blockquote>
              <p>当字符串编码表的长度为1024($2^{10}$)时,在此之前出现的所有编码都小于1024($2^{10}$)，若用长度16来保存编码未免也太浪费空间了。<br>只有动态地改变保存长度，才能更加有效地利用存储空间，使压缩效果更好。<br>那如何做到这一点呢？还是利用用<strong>“哨兵”</strong>就能做到。</p>
              <p>比如字符串编码表长度为512($2^9$)时,设立一个<strong>“变长哨兵值”</strong>为$2^{10} - 1 = 1023$，当字符串编码长度达到这个<strong>“变长哨兵值”</strong>之前，以长度10来保存,达到之后以长度11来保存，且生成新的<strong>“变长哨兵值”</strong>，如此重复，最后达到<strong>“重置哨兵值”</strong>。</p>
              <h2 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h2>
              <script src="https://gist.github.com/linw1995/38b805e35d667d45e51612c11c71a70b.js"></script>
              <p>GIST: <a href="https://gist.github.com/linw1995/38b805e35d667d45e51612c11c71a70b" target="_blank" rel="external">LZW Encoding and Data Compression. | linw1995</a></p>
              <h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2>
              <blockquote class="pullquote">
                <ul>
                  <li><a href="https://zh.wikipedia.org/zh-hans/LZW" target="_blank" rel="external">LZW | Wikipedia</a></li>
                </ul>
              </blockquote>
            </div>
            <script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://linw1995.com/2017/10/24/自己来写压缩算法——LZW/" data-id="cj94wmc7a002g3185971c4osv" class="article-share-link">Share</a>
            <div class="tags"><a href="/tags/Python/">Python</a></div>
            <div class="post-nav"><a href="/2017/09/24/自己来写压缩算法——哈夫曼算法/" class="next">自己来写压缩算法——哈夫曼算法</a></div>
            <div id="disqus_thread">
              <div class="btn_click_load"><button class="disqus_click_btn">阅读评论 「请确保 disqus.com 可以正常加载」</button></div>
              <script>
                var disqus_shortname = 'linw1995';
                var disqus_identifier = '2017/10/24/自己来写压缩算法——LZW/';
                var disqus_title = '自己来写压缩算法——LZW';
                var disqus_url = 'http://linw1995.com/2017/10/24/自己来写压缩算法——LZW/';
                $('.btn_click_load').click(function() {
                  (function() {
                    var dsq = document.createElement('script');
                    dsq.type = 'text/javascript';
                    dsq.async = true;
                    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                  })();
                  $('.btn_click_load').css('display', 'none');
                });
                $.ajax({
                  url: 'https://disqus.com/favicon.ico',
                  timeout: 3000,
                  type: 'GET',
                  success: (function() {
                    var dsq = document.createElement('script');
                    dsq.type = 'text/javascript';
                    dsq.async = true;
                    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                    $('.btn_click_load').css('display', 'none');
                  })(),
                  error: function() {
                    $('.btn_click_load').css('display', 'block');
                  }
                });
              </script>
              <script id="dsq-count-scr" src="//linw1995.disqus.com/count.js" async></script>
            </div>
          </div>
        </div>
      </div>
      <div class="pure-u-1 pure-u-md-4-4">
        <div id="footer">Copyright © 2017 <a href="/." rel="nofollow">linw1995.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow"
            target="_blank" href="https://github.com/pagecho"> Cho.</a></div>
      </div>
    </div><a id="rocket" href="#top" class="show"></a>
    <script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script>
    <script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.js" async></script>
    <script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script>
    <link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.css">
    <script type="text/javascript" src="/js/search.js?v=0.0.0"></script>
    <script>
      var search_path = 'search.xml';
      if (search_path.length == 0) {
        search_path = 'search.xml';
      }
      var path = '/' + search_path;
      searchFunc(path, 'local-search-input', 'local-search-result');
    </script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({ showMathMenu: false, jax: ["input/TeX","output/CommonHTML"], tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]} }); </script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"
      async></script>
    <script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script>
    <script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script>
  </div>
</body>

</html>